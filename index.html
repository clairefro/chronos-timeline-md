<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chronos Timeline Markdown Playground</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        height: 100vh;
        background: #f8f9fa;
      }

      .header {
        background: #24292e;
        color: white;
        padding: 1rem 2rem;
        border-bottom: 1px solid #e1e4e8;
      }

      .header h1 {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .header p {
        color: #959da5;
        margin-top: 0.5rem;
      }

      .container {
        display: flex;
        height: calc(100vh - 80px);
      }

      .input-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
        min-width: 200px;
      }

      .output-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
        min-width: 200px;
      }

      .divider {
        width: 8px;
        background: #f6f8fa;
        border-left: 1px solid #e1e4e8;
        border-right: 1px solid #e1e4e8;
        cursor: col-resize;
        position: relative;
        transition: background-color 0.2s;
      }

      .divider:hover {
        background: #e1e4e8;
      }

      .divider::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 3px;
        height: 20px;
        background: #c6c8cc;
        border-radius: 1px;
        box-shadow: -2px 0 0 #c6c8cc, 2px 0 0 #c6c8cc;
      }

      .panel-header {
        background: #f6f8fa;
        border-bottom: 1px solid #e1e4e8;
        padding: 0.75rem 1rem;
        font-weight: 600;
        color: #24292e;
      }

      .chronos-error-message-container {
        color: rgb(223, 0, 0) !important;
        background-color: #ffd0d0;
      }

      .input-area {
        flex: 1;
        padding: 1rem;
      }

      #markdown-input {
        width: 100%;
        height: 100%;
        border: none;
        resize: none;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 14px;
        line-height: 1.5;
        background: #fafbfc;
        padding: 1rem;
        border-radius: 6px;
        border: 1px solid #e1e4e8;
        outline: none;
      }

      #markdown-input:focus {
        border-color: #0366d6;
        box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
      }

      .output-area {
        flex: 1;
        padding: 1rem;
        overflow: auto;
      }

      #timeline-container {
        width: 100%;
        min-height: 200px;
        border: 1px solid #e1e4e8;
        background: white;
      }

      .controls {
        padding: 1rem;
        background: #f6f8fa;
        border-bottom: 1px solid #e1e4e8;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .control-group label {
        font-size: 14px;
        color: #586069;
      }

      .control-group select,
      .control-group input {
        padding: 0.25rem 0.5rem;
        border: 1px solid #e1e4e8;
        border-radius: 4px;
        font-size: 14px;
      }

      .export-controls {
        padding: 1rem;
        background: #f6f8fa;
        border-top: 1px solid #e1e4e8;
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .instructions-box {
        background: #f6f8fa;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        padding: 1rem;
        margin: 1rem;
        margin-top: 0;
      }

      .instructions-box h3 {
        margin: 0 0 0.5rem 0;
        font-size: 14px;
        font-weight: 600;
        color: #24292e;
      }

      .instructions-box ul {
        margin: 0;
        padding-left: 1.2rem;
        font-size: 14px;
        color: #586069;
        line-height: 1.4;
      }

      .instructions-box li {
        margin-bottom: 0.25rem;
      }

      .export-btn {
        background: #0366d6;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .export-btn:hover {
        background: #005cc5;
      }

      .export-btn:disabled {
        background: #94a3b8;
        cursor: not-allowed;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: #586069;
      }

      .env-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        background: #28a745;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
      }

      .env-indicator.local {
        background: #17a2b8;
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
        }

        .divider {
          display: none;
        }

        .input-panel {
          border-bottom: 1px solid #e1e4e8;
        }
      }
    </style>
  </head>
  <body>
    <div id="env-indicator" class="env-indicator">Loading...</div>

    <div class="header">
      <h1>Chronos Timeline Markdown Playground</h1>
      <p>
        Write chronological markdown on the left, see the timeline visualization
        on the right
      </p>
    </div>

    <div class="container">
      <div class="input-panel">
        <div class="panel-header">Markdown Input</div>
        <div class="controls">
          <div class="control-group">
            <label for="locale-select">Locale:</label>
            <select id="locale-select">
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="ja">Japanese</option>
              <option value="zh">Chinese</option>
            </select>
          </div>
          <div class="control-group">
            <label for="round-ranges">
              <input type="checkbox" id="round-ranges" /> Round Ranges
            </label>
          </div>
          <div class="control-group">
            <label for="alignment">Alignment:</label>
            <select id="alignment">
              <option value="left">Left</option>
              <option value="center">Center</option>
              <option value="right">Right</option>
            </select>
          </div>
          <div class="control-group">
            <label for="examples-select">Examples:</label>
            <select id="examples-select">
              <option value="">Insert Example...</option>
            </select>
          </div>
        </div>
        <div class="input-area">
          <textarea id="markdown-input"></textarea>
        </div>
      </div>

      <div class="divider" id="divider"></div>

      <div class="output-panel">
        <div class="panel-header">Timeline</div>
        <div class="output-area">
          <div id="timeline-container">
            <div class="loading">
              Enter markdown content to see the timeline visualization
            </div>
          </div>
        </div>
        <div class="instructions-box">
          <h3>Instructions</h3>
          <ul>
            <li>Write your timeline in the markdown editor on the left</li>
            <li>
              Use dates in YYYY-MM-DD format followed by item descriptions
            </li>
            <li>Try the examples in the dropdown menu to get started</li>
          </ul>
        </div>
        <div class="export-controls">
          <button id="export-png-btn" class="export-btn" disabled>
            Export as PNG
          </button>
          <button id="share-link-btn" class="export-btn">
            Copy Share Link to Clipboard
          </button>
          <span
            id="export-status"
            style="color: #586069; font-size: 14px"
          ></span>
        </div>
      </div>
    </div>

    <!-- Smart Loading Script -->
    <script>
      // Detect environment and load appropriate Chronos library
      async function loadChronos() {
        const isGitHubPages = window.location.hostname.includes("github.io");
        const isLocalhost =
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1";

        // Update environment indicator
        const envIndicator = document.getElementById("env-indicator");

        try {
          let chronosLibrary;

          if (isLocalhost) {
            // Local development - try ES modules first, fallback to IIFE
            envIndicator.textContent = "Local Dev";
            envIndicator.className = "env-indicator local";

            try {
              console.log("Loading local ES modules...");
              chronosLibrary = await import("./dist/index.js");
            } catch (esError) {
              console.log("ES modules failed, trying local IIFE...");
              await loadScript("./dist/iife-entry.global.js");
              chronosLibrary = window.ChronosTimeline;
            }
          } else if (isGitHubPages) {
            // GitHub Pages - use CDN
            envIndicator.textContent = "GitHub Pages";
            console.log("Loading from CDN...");

            // Show loading message in timeline container for GitHub Pages
            document.getElementById("timeline-container").innerHTML =
              '<div class="loading">Loading...</div>';

            await loadScript(
              "https://unpkg.com/chronos-timeline-md@latest/dist/iife-entry.global.js"
            );
            chronosLibrary = window.ChronosTimeline;
          } else {
            // Other hosting - try CDN first, fallback to local
            envIndicator.textContent = "Production";
            try {
              await loadScript(
                "https://unpkg.com/chronos-timeline-md@latest/dist/iife-entry.global.js"
              );
              chronosLibrary = window.ChronosTimeline;
            } catch (cdnError) {
              console.log("CDN failed, trying local...");
              await loadScript("./dist/iife-entry.global.js");
              chronosLibrary = window.ChronosTimeline;
            }
          }

          if (!chronosLibrary) {
            throw new Error("Failed to load Chronos library");
          }

          // Initialize the app
          const {
            ChronosTimeline,
            parseChronos,
            renderChronos,
            attachChronosStyles,
          } = chronosLibrary;
          initializeApp({
            ChronosTimeline,
            parseChronos,
            renderChronos,
            attachChronosStyles,
          });

          // Hide environment indicator after successful load
          setTimeout(() => {
            envIndicator.style.display = "none";
          }, 2000);
        } catch (error) {
          console.error("Failed to load Chronos library:", error);
          envIndicator.textContent = "Error";
          envIndicator.style.background = "#dc3545";
          document.getElementById(
            "timeline-container"
          ).innerHTML = `<div class="error-message">Failed to load Chronos library: ${error.message}</div>`;
        }
      }

      // Helper function to load scripts dynamically
      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = src;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      // Initialize the application (same code for all environments)
      function initializeApp({
        ChronosTimeline,
        parseChronos,
        renderChronos,
        attachChronosStyles,
      }) {
        console.log("Initializing Chronos Timeline App...");

        // Display version information if available
        if (ChronosTimeline.version) {
          console.log(`Chronos Timeline version: ${ChronosTimeline.version}`);

          // Log available static properties for developers
          console.log(
            "Available templates:",
            Object.keys(ChronosTimeline.templates || {})
          );
          console.log("Cheatsheet available:", !!ChronosTimeline.cheatsheet);
          console.log(
            "AI prompt available:",
            !!ChronosTimeline.prompts?.system
          );

          // Add version to header
          const versionDisplay = document.createElement("div");
          versionDisplay.style.cssText =
            "position: absolute; top: 15px; right: 20px; color: #959da5; font-size: 0.85rem; z-index: 1000; background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 3px;";
          versionDisplay.textContent = `v${ChronosTimeline.version}`;
          document.querySelector(".header").appendChild(versionDisplay);

          // Also add version to page title
          document.title = `Chronos Timeline v${ChronosTimeline.version} - Markdown Playground`;

          // Update the header subtitle to include version
          const headerP = document.querySelector(".header p");
          if (headerP) {
            headerP.innerHTML = `Write chronological markdown on the left, see the timeline visualization on the right <span style="color: #6a737d; font-size: 0.9em;">(v${ChronosTimeline.version})</span>`;
          }
        } else {
          console.warn("ChronosTimeline.version not available");
          // Add a fallback version indicator
          const versionDisplay = document.createElement("div");
          versionDisplay.style.cssText =
            "position: absolute; top: 15px; right: 20px; color: #dc3545; font-size: 0.85rem; z-index: 1000; background: rgba(220,53,69,0.1); padding: 2px 6px; border-radius: 3px;";
          versionDisplay.textContent = "version unknown";
          document.querySelector(".header").appendChild(versionDisplay);
        }

        // All your existing JavaScript code goes here
        // This is the SAME code for both local dev and GitHub Pages

        // DOM elements
        const markdownInput = document.getElementById("markdown-input");
        const timelineContainer = document.getElementById("timeline-container");
        const localeSelect = document.getElementById("locale-select");
        const roundRangesCheckbox = document.getElementById("round-ranges");
        const alignmentSelect = document.getElementById("alignment");
        const examplesSelect = document.getElementById("examples-select");
        const exportPngBtn = document.getElementById("export-png-btn");
        const shareLinkBtn = document.getElementById("share-link-btn");
        const exportStatus = document.getElementById("export-status");
        const divider = document.getElementById("divider");
        const inputPanel = document.querySelector(".input-panel");
        const outputPanel = document.querySelector(".output-panel");
        const container = document.querySelector(".container");

        let currentTimeline = null;
        let debounceTimer = null;

        // Resizable divider functionality
        let isResizing = false;

        function initializeResizer() {
          divider.addEventListener("mousedown", startResizing);
          document.addEventListener("mousemove", handleResize);
          document.addEventListener("mouseup", stopResizing);
        }

        function startResizing(e) {
          isResizing = true;
          document.body.style.cursor = "col-resize";
          document.body.style.userSelect = "none";
          e.preventDefault();
        }

        function handleResize(e) {
          if (!isResizing) return;

          const containerRect = container.getBoundingClientRect();
          const mouseX = e.clientX - containerRect.left;

          // Calculate percentages
          const totalWidth = containerRect.width - 8; // Subtract divider width
          const leftPercent = Math.max(
            20,
            Math.min(80, (mouseX / containerRect.width) * 100)
          );
          const rightPercent = 100 - leftPercent;

          // Apply the new flex basis
          inputPanel.style.flexBasis = `${leftPercent}%`;
          outputPanel.style.flexBasis = `${rightPercent}%`;

          // Ensure panels don't shrink below flex basis
          inputPanel.style.flexShrink = "0";
          outputPanel.style.flexShrink = "0";
        }

        function stopResizing() {
          if (isResizing) {
            isResizing = false;
            document.body.style.cursor = "";
            document.body.style.userSelect = "";

            // Trigger timeline redraw after resize
            if (
              currentTimeline &&
              currentTimeline.timeline &&
              typeof currentTimeline.timeline.redraw === "function"
            ) {
              setTimeout(() => {
                currentTimeline.timeline.redraw();
              }, 100);
            }
          }
        }

        // Undo functionality
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;

        // URL state management
        function updateURL() {
          const content = markdownInput.value;
          const locale = localeSelect.value;
          const url = new URL(window.location);

          if (content.trim()) {
            url.searchParams.set("content", content);
          } else {
            url.searchParams.delete("content");
          }

          if (locale && locale !== "en") {
            url.searchParams.set("locale", locale);
          } else {
            url.searchParams.delete("locale");
          }

          window.history.replaceState({}, "", url);
        }

        function loadFromURL() {
          try {
            const queryString = window.location.search;
            if (!queryString) return false;

            const urlParams = new URLSearchParams(queryString);
            const content = urlParams.get("content");
            const locale = urlParams.get("locale");
            let hasContent = false;

            // Load locale if present
            if (locale && localeSelect) {
              const option = localeSelect.querySelector(
                `option[value="${locale}"]`
              );
              if (option) {
                localeSelect.value = locale;
              }
            }

            // Load content if present
            if (content) {
              markdownInput.value = content;
              hasContent = true;
            }

            return hasContent;
          } catch (error) {
            console.error("Error loading content from URL:", error);
            try {
              const matches =
                window.location.search.match(/[?&]content=([^&]*)/);
              if (matches && matches[1]) {
                const content = decodeURIComponent(
                  matches[1].replace(/\+/g, " ")
                );
                markdownInput.value = content;
                return true;
              }
            } catch (fallbackError) {
              console.error("Fallback URL parsing also failed:", fallbackError);
            }
          }
          return false;
        }

        // History management
        function addToHistory(content) {
          if (historyIndex < history.length - 1) {
            history = history.slice(0, historyIndex + 1);
          }
          history.push(content);

          if (history.length > MAX_HISTORY) {
            history = history.slice(1);
            historyIndex = Math.max(0, historyIndex - 1);
          }

          historyIndex = history.length - 1;
        }

        function undo() {
          if (historyIndex > 0) {
            historyIndex--;
            const previousContent = history[historyIndex];
            markdownInput.value = previousContent;
            updateURL();
            renderTimeline();
            return true;
          }
          return false;
        }

        function redo() {
          if (historyIndex < history.length - 1) {
            historyIndex++;
            const nextContent = history[historyIndex];
            markdownInput.value = nextContent;
            updateURL();
            renderTimeline();
            return true;
          }
          return false;
        }

        // Examples
        const chronosExamples = [
          {
            title: "Date Formats",
            content: `- [2020] A year
- [2020-02] A month
- [2020-02-28] A day
- [2020-02-28T12] An hour
- [2020-02-28T12:30] A minute
- [2020-02-28T12:30:09] A second`,
          },
          {
            title: "Single Event (-)",
            content: `- [1879-03-14] Einstein born`,
          },
          {
            title: "Date Range",
            content: `- [1991~2001] Time I believed in Santa`,
          },
          {
            title: "Event with Description (|)",
            content: `- [1991~2001] Time I believed in Santa | ended when my brother tried to videotape Santa with a hidden camera
          # Hover on a timeline item to see its description`,
          },
          {
            title: "Colored Events (#color)",
            content: `- [2001~2009] #red Bush
- [2009~2017] #blue Obama
- [2017~2021] #red Trump
- [2021~2025] #blue Biden

# You can also use custom hex-code colors like #dd6689`,
          },
          {
            title: "Groups Example ({})",
            content: `@ [1892-10-08~1941-08-31] {Marina Tsvetaeva} 1892-1941
- [1916] {Marina Tsvetaeva} "Подруга"
- [1928] {Marina Tsvetaeva}  "Поэма концов"
- [1941] {Marina Tsvetaeva} "Записки о поэзии"

@ [1899-08-24~1986-06-14] {Jorge Luis Borges} 1899-1986
- [1944] {Jorge Luis Borges} "Ficciones"
- [1949] {Jorge Luis Borges} "El Aleph"
- [1962] {Jorge Luis Borges} "Labyrinths"`,
          },
          {
            title: "Periods (@)",
            content: `@ [-300~250] Yayoi Period
- [-100] Introduction of rice cultivation
- [-57] Japan's first recorded contact with China`,
          },
          {
            title: "Colored Periods",
            content: `@ [-300~250] #red Yayoi Period
- [-100] Introduction of rice cultivation
- [-57] Japan's first recorded contact with China

@ [250~538] Kofun Period
- [250] Construction of keyhole-shaped kofun burial mounds begins
- [369] Yamato state sends envoys to Korea`,
          },
          {
            title: "Points (*)",
            content: `- [2024-02-26~2024-03-10] Tournament
* [2024-02-26] Game 1 | Austin
* [2024-02-28] Game 2 | Los Angeles
* [2024-03-06] Game 3 | Tokyo
* [2024-03-10] Game 4 | Jakarta`,
          },
          {
            title: "Markers (=)",
            content: `= [1440] Invention of the Gutenberg Press

- [1455] Gutenberg Bible Printed
@ [1501~1600] The Spread of Printing
- [1517] Martin Luther's 95 Theses`,
          },
          {
            title: "Ordering by Start",
            content: `> ORDERBY start

- [2026~2028] Event D
- [2024~2028] Event B
- [2025~2030] #red Event C
- [2020~2030] #red Event A`,
          },
          {
            title: "Options: Ordering by Color and Start date",
            content: `> ORDERBY color|start

- [2026~2028] Event D
- [2024~2028] Event B
- [2025~2030] #red Event C
- [2020~2030] #red Event A`,
          },
          {
            title: "Options: Default View",
            content: `> DEFAULTVIEW -3000|3000
# Offset the default centered view with custom start|end dates

- [2024] AGI`,
          },
          {
            title: "Cold War Timeline",
            content: `- [1945-07-17] {Europe} Potsdam Conference | where post-WWII Europe is divided
- [1947-03-12] {USA} Truman Doctrine | committing the U.S. to containing communism
- [1948-06-24~1949-05-12] {Europe} Berlin Blockade | and Airlift in response to Soviet actions in Berlin
- [1949-04-04] {Europe} Formation of NATO

@ [1957~1969] #cyan {USSR} Space Race
@ [1957~1969] #cyan {USA} Space Race
- [1950-06-25~1953-07-27] {Asia} Korean War | between North and South Korea
- [1955-05-14] {USSR} Warsaw Pact | in response to NATO
- [1957-10-04] #cyan {USSR} Sputnik launched | initiating the Space Race
- [1961-04-17] {Cuba} Bay of Pigs Invasion | in Cuba

- [1962-10-16] {Cuba} Cuban Missile Crisis | a peak confrontation between the U.S. and USSR
- [1963-08-05] {Global} Partial Nuclear Test Ban Treaty signed
- [1969-07-20] #cyan {USA} Apollo 11 Moon landing | U.S. wins the Space Race
- [1972-05-26] {Global} SALT I signed | first Strategic Arms Limitation Treaty

- [1979-12-24~1989-02-15] {USSR} Soviet-Afghan War | straining Soviet resources
- [1983-03-23] {USA} Reagan announces the Strategic Defense Initiative (SDI)
- [1986-04-26] {USSR} Chernobyl nuclear disaster
- [1987-12-08] {Global} INF Treaty | signed, eliminating intermediate-range nuclear missiles

- [1989-11-09] {Europe} Fall of the Berlin Wall | symbolizing the end of Cold War tensions
- [1991-07-31] {Global} START I Treaty signed | further arms reduction
- [1991-12-26] {USSR} Dissolution of the Soviet Union | officially ending the Cold War

= [1991-12-26] End of the Cold War`,
          },
        ];

        function populateExamplesDropdown() {
          examplesSelect.innerHTML =
            '<option value="">Insert Example...</option>';
          chronosExamples.forEach((example, index) => {
            const option = document.createElement("option");
            option.value = index;
            option.textContent = example.title;
            examplesSelect.appendChild(option);
          });
        }

        function insertExample() {
          const selectedIndex = examplesSelect.value;
          if (selectedIndex === "") return;

          const example = chronosExamples[selectedIndex];
          if (example) {
            addToHistory(markdownInput.value);
            markdownInput.value = example.content;
            updateURL(); // Update URL when example is inserted
            renderTimeline();
          }
          examplesSelect.value = "";
        }

        // Initialize styles
        attachChronosStyles();

        function renderTimeline() {
          const markdownContent = markdownInput.value.trim();

          if (!markdownContent) {
            timelineContainer.innerHTML =
              '<div class="loading">Enter markdown content to see the timeline visualization</div>';
            return;
          }

          try {
            if (currentTimeline) {
              try {
                if (
                  currentTimeline.timeline &&
                  typeof currentTimeline.timeline.destroy === "function"
                ) {
                  currentTimeline.timeline.destroy();
                }
              } catch (e) {
                console.warn("Error destroying previous timeline:", e);
              }
              currentTimeline = null;
            }

            timelineContainer.innerHTML = "";

            // Create timeline using new constructor API
            const timeline = new ChronosTimeline({
              container: timelineContainer,
              settings: {
                selectedLocale: localeSelect.value,
                align: alignmentSelect.value,
                clickToUse: false,
                roundRanges: roundRangesCheckbox.checked,
                useUtc: true,
                useAI: false,
              },
              callbacks: {
                setTooltip: (el, text) => {
                  el.setAttribute("title", text);
                },
              },
            });

            // Render the timeline and store reference
            timeline.render(markdownContent);

            // Create compatibility structure for export functionality
            currentTimeline = {
              timeline,
              parsed: {
                items: timeline.items || [],
              },
            };

            // Check if there are parse errors first
            const hasErrors = timelineContainer.querySelector(
              ".chronos-error-message-container"
            );

            if (hasErrors) {
              // Parse errors are already displayed by ChronosTimeline
              exportPngBtn.disabled = true;
            } else if (currentTimeline.parsed.items.length === 0) {
              timelineContainer.innerHTML =
                '<div class="loading">No timeline items found. Try adding dates in your markdown</div>';
              exportPngBtn.disabled = true;
            } else {
              exportPngBtn.disabled = false;
            }
          } catch (error) {
            console.error("Timeline rendering error:", error);
            timelineContainer.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            exportPngBtn.disabled = true;
          }
        }

        function debouncedURLUpdate() {
          clearTimeout(debounceTimer);
          updateURL();
          debounceTimer = setTimeout(renderTimeline, 300);
        }

        // Keyboard shortcuts
        function handleKeyboardShortcuts(event) {
          if (
            (event.ctrlKey || event.metaKey) &&
            event.key === "z" &&
            !event.shiftKey
          ) {
            event.preventDefault();
            undo();
          } else if (
            (event.ctrlKey || event.metaKey) &&
            event.key === "z" &&
            event.shiftKey
          ) {
            event.preventDefault();
            redo();
          } else if ((event.ctrlKey || event.metaKey) && event.key === "y") {
            event.preventDefault();
            redo();
          }
        }

        // Track changes for history
        let lastContent = "";
        let changeTimer = null;

        function trackContentChanges() {
          const currentContent = markdownInput.value;
          if (
            currentContent !== lastContent &&
            currentContent !== (history[historyIndex] || "")
          ) {
            clearTimeout(changeTimer);
            changeTimer = setTimeout(() => {
              addToHistory(currentContent);
              lastContent = currentContent;
            }, 1000);
          }
        }

        // Handle locale changes
        function handleLocaleChange() {
          updateURL();
          renderTimeline();
        }

        // PNG Export functionality
        function exportToPNG() {
          if (!currentTimeline || !currentTimeline.timeline) {
            exportStatus.textContent = "No timeline to export";
            return;
          }

          try {
            exportStatus.textContent = "Generating PNG...";
            exportPngBtn.disabled = true;

            // Create a canvas from the timeline container
            import(
              "https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.esm.js"
            )
              .then(({ default: html2canvas }) => {
                const timelineElement =
                  timelineContainer.querySelector(".vis-timeline");
                if (!timelineElement) {
                  throw new Error("Timeline element not found");
                }

                return html2canvas(timelineElement, {
                  backgroundColor: "#ffffff",
                  scale: 2, // Higher resolution
                  useCORS: true,
                  allowTaint: true,
                });
              })
              .then((canvas) => {
                // Create download link
                const link = document.createElement("a");
                link.download = `chronos-timeline-${
                  new Date().toISOString().split("T")[0]
                }.png`;
                link.href = canvas.toDataURL("image/png");

                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                exportStatus.textContent = "PNG exported successfully!";
                setTimeout(() => {
                  exportStatus.textContent = "";
                }, 3000);
              })
              .catch((error) => {
                console.error("PNG export failed:", error);
                exportStatus.textContent = "Export failed. Try again.";
                setTimeout(() => {
                  exportStatus.textContent = "";
                }, 3000);
              })
              .finally(() => {
                exportPngBtn.disabled = false;
              });
          } catch (error) {
            console.error("PNG export error:", error);
            exportStatus.textContent = "Export failed. Try again.";
            exportPngBtn.disabled = false;
            setTimeout(() => {
              exportStatus.textContent = "";
            }, 3000);
          }
        }

        // Share Link functionality
        function shareLink() {
          try {
            // Ensure URL is up to date with current content
            updateURL();

            const currentUrl = window.location.href;

            // Try to use the Clipboard API if available
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard
                .writeText(currentUrl)
                .then(() => {
                  exportStatus.textContent = "Link copied to clipboard!";
                  setTimeout(() => {
                    exportStatus.textContent = "";
                  }, 3000);
                })
                .catch((error) => {
                  console.error("Clipboard write failed:", error);
                  fallbackCopyToClipboard(currentUrl);
                });
            } else {
              // Fallback for older browsers
              fallbackCopyToClipboard(currentUrl);
            }
          } catch (error) {
            console.error("Share link error:", error);
            exportStatus.textContent = "Failed to copy link";
            setTimeout(() => {
              exportStatus.textContent = "";
            }, 3000);
          }
        }

        // Fallback clipboard function for older browsers
        function fallbackCopyToClipboard(text) {
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed";
          textArea.style.left = "-999999px";
          textArea.style.top = "-999999px";
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();

          try {
            document.execCommand("copy");
            exportStatus.textContent = "Link copied to clipboard!";
            setTimeout(() => {
              exportStatus.textContent = "";
            }, 3000);
          } catch (error) {
            console.error("Fallback copy failed:", error);
            exportStatus.textContent = "Copy failed. Please copy URL manually.";
            setTimeout(() => {
              exportStatus.textContent = "";
            }, 5000);
          } finally {
            document.body.removeChild(textArea);
          }
        }

        // Event listeners
        markdownInput.addEventListener("input", () => {
          debouncedURLUpdate();
          trackContentChanges();
        });
        localeSelect.addEventListener("change", handleLocaleChange);
        roundRangesCheckbox.addEventListener("change", renderTimeline);
        alignmentSelect.addEventListener("change", renderTimeline);
        examplesSelect.addEventListener("change", insertExample);
        exportPngBtn.addEventListener("click", exportToPNG);
        shareLinkBtn.addEventListener("click", shareLink);
        document.addEventListener("keydown", handleKeyboardShortcuts);

        // Initialize
        initializeResizer();
        populateExamplesDropdown();
        const hasURLContent = loadFromURL();
        if (!hasURLContent) {
          // Use current date for "You are here" default content
          const today = new Date().toISOString().split("T")[0];
          markdownInput.value = `- [2000~4160] Age of Aquarius
* [${today}] You are here`;
        }
        addToHistory(markdownInput.value);
        lastContent = markdownInput.value;

        // Ensure URL reflects current state
        updateURL();
        renderTimeline();

        // Handle window resize
        window.addEventListener("resize", () => {
          if (
            currentTimeline &&
            currentTimeline.timeline &&
            typeof currentTimeline.timeline.redraw === "function"
          ) {
            currentTimeline.timeline.redraw();
          }
        });
      }

      // Start the application
      loadChronos();
    </script>
  </body>
</html>
